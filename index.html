<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HKO â€” Warnings, Today & 3-Day Forecast</title>
<meta name="color-scheme" content="light dark"/>
<style>
  :root{
    --bg:#f0f2f5; --text:#111; --muted:#6e6e73; --border:rgba(0,0,0,.08);
    --card-bg:rgba(255,255,255,.82); --shadow:0 14px 40px rgba(0,0,0,.10);
    --warn-icon: 64px; --today-icon: 52px; --gap: 12px; --card-max: 560px;
  }
  @media(prefers-color-scheme:dark){
    :root{ --bg:#0b0b0c; --text:#f5f5f7; --muted:#a1a1a6; --border:rgba(255,255,255,.14);
           --card-bg:rgba(30,30,32,.8); --shadow:0 18px 50px rgba(0,0,0,.6); }
  }
  html,body{
    margin:0;min-height:100vh;background:var(--bg);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
    color:var(--text);display:grid;place-items:center;
  }
  .card{
    width:min(92vw,var(--card-max));border:1px solid var(--border);border-radius:28px;
    background:var(--card-bg);backdrop-filter:saturate(180%) blur(22px);
    -webkit-backdrop-filter:saturate(180%) blur(22px);box-shadow:var(--shadow);
    padding:clamp(14px, 2.8vw, 22px);display:flex;flex-direction:column;gap:clamp(8px, 1.8vw, 14px);
  }

  .clock{ font-size: clamp(14px, 2.2vw, 18px); font-weight:600;text-align:center; }
  .row-label{ font-size: clamp(11px, 1.8vw, 13px); color:var(--muted); margin:2px 4px 4px; }

  /* Warning icons â€” single line */
  .icons-row{
    display:flex; align-items:center; gap:var(--gap);
    flex-wrap:nowrap; overflow:hidden;
  }
.icons-row img {
Â  width: var(--warn-icon);
Â  height: var(--warn-icon);
Â  object-fit: contain;
Â  flex: 0 0 auto;

}

  /* Today line */
  .today-line{
    display:flex; align-items:center; gap:clamp(6px, 1.5vw, 10px);
    font-size: clamp(13px, 2vw, 15px); font-weight:500;
  }
  .today-line img{ width:var(--today-icon); height:var(--today-icon); object-fit:contain; }

  /* Forecast table */
  .fnd-wrap{ margin-top: 2px; }
  table.fnd{
    width:100%; border-collapse:collapse; border-spacing:0;
    font-size: clamp(12px, 1.9vw, 14px);
  }
  .fnd th, .fnd td{
    padding: 8px 10px; border-top:1px solid var(--border); vertical-align:middle;
  }
  .fnd th{ text-align:left; color:var(--muted); font-weight:600; }
  .fnd td.icon-cell{ width:56px; }
  .fnd td.icon-cell img{ width:40px; height:40px; object-fit:contain; }
  .fnd .temp{ white-space:nowrap; font-variant-numeric:tabular-nums; }
  .fnd .desc{ color:var(--muted); }

  .footer{
    display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;
    gap:8px;color:var(--muted);font-size:clamp(11px, 1.8vw, 13px);margin-top:6px
  }
  .btn{
    border:1px solid var(--border);background:transparent;color:inherit;
    font-weight:600;border-radius:14px;padding:clamp(6px, 1.2vw, 8px) clamp(10px, 2vw, 12px);
    cursor:pointer;font-size:clamp(12px, 1.9vw, 13px)
  }


</style>
</head>
<body>

<div class="card" id="hko-card">
  <!-- Live HK date + time -->
  <div id="hkClock" class="clock">--</div>

  <!-- Warning icons (single line, no names) -->
  <div class="row-label">Active warnings</div>
  <div class="icons-row" id="hko-icons"></div>

  <!-- Today line (text + icon same line) -->
  <div class="today-line">
    <span>Today:</span>
    <img id="weather-icon" alt="" src=""/>
  </div>

  <!-- 3-day forecast table -->
  <div class="fnd-wrap">
    <table class="fnd" id="fndTable" aria-label="3-day forecast">
      <thead>
        <tr>
          <th>Date</th>
          <th>Icon</th>
          <th>Temp (Â°C)</th>
          <th>Weather</th>
        </tr>
      </thead>
      <tbody id="fndBody">
        <!-- rows inserted here -->
      </tbody>
    </table>
  </div>

  <!-- Footer -->
  <div class="footer">
    <button id="refreshBtn" class="btn" type="button">Refresh</button>
    <span id="lastRefresh">Last checked: --</span>
  </div>
</div>

<script>
Â  // ---------------- Language (auto + manual switcher, no HTML/CSS changes) ----------------
Â  const I18N = {
Â  Â  en: {
Â  Â  Â  activeWarnings: 'Active warnings',
Â  Â  Â  today: 'Today:',
Â  Â  Â  lastChecked: 'Last checked: ',
Â  Â  Â  noWarning: 'No warning is issued',
Â  Â  Â  error: 'âš ï¸ Error loading data',
Â  Â  Â  location: 'Location:',
Â  Â  Â  temp: 'Temp',
Â  Â  Â  raining: 'Raining',
Â  Â  Â  langEN: 'EN',
Â  Â  Â  langTC: 'ä¸­',
Â  Â  Â  theme: 'Theme',
Â  Â  Â  themeAuto: 'Auto',
Â  Â  Â  themeLight: 'Light',
Â  Â  Â  themeDark: 'Dark',
Â  Â  Â  detailsMore: 'More details',
Â  Â  Â  detailsLess: 'Less details'
Â  Â  },
Â  Â  tc: {
Â  Â  Â  activeWarnings: 'ç”Ÿæ•ˆè­¦å‘Š',
Â  Â  Â  today: 'ä»Šæ—¥ï¼š',
Â  Â  Â  lastChecked: 'ä¸Šæ¬¡æ›´æ–°ï¼š',
Â  Â  Â  noWarning: 'ç¾æ™‚æ²’æœ‰è­¦å‘Š',
Â  Â  Â  error: 'âš ï¸ è¼‰å…¥è³‡æ–™æ™‚å‡ºéŒ¯',
Â  Â  Â  location: 'åœ°é»ï¼š',
Â  Â  Â  temp: 'æ°£æº«',
Â  Â  Â  raining: 'é™é›¨æ©Ÿç‡',
Â  Â  Â  langEN: 'EN',
Â  Â  Â  langTC: 'ä¸­',
Â  Â  Â  theme: 'ä¸»é¡Œ',
Â  Â  Â  themeAuto: 'è‡ªå‹•',
Â  Â  Â  themeLight: 'æ·ºè‰²',
Â  Â  Â  themeDark: 'æ·±è‰²',
Â  Â  Â  detailsMore: 'æ›´å¤šè©³æƒ…',
Â  Â  Â  detailsLess: 'æ”¶èµ·è©³æƒ…'
Â  Â  }
Â  };

Â  function detectLang(){
Â  Â  const url = new URL(location.href);
Â  Â  const q = (url.searchParams.get('lang') || '').toLowerCase();
Â  Â  if (q === 'en' || q === 'tc') return q;
Â  Â  const saved = localStorage.getItem('hkoLang');
Â  Â  if (saved === 'en' || saved === 'tc') return saved;
Â  Â  const nav = (navigator.language || '').toLowerCase();
Â  Â  if (nav.startsWith('zh-hant') || nav === 'zh-hk' || nav === 'zh-tw') return 'tc';
Â  Â  return 'en';
Â  }
Â  let LANG = detectLang();
Â  const t = (k) => (I18N[LANG] && I18N[LANG][k]) || I18N.en[k];

Â  function setLang(lang){
Â  Â  if (lang !== 'en' && lang !== 'tc') return;
Â  Â  LANG = lang;
Â  Â  localStorage.setItem('hkoLang', lang);
Â  Â  applyStaticLabels();
Â  Â  fetchAll(); // re-fetch in chosen language
Â  Â  highlightLangButton();
Â  Â  updateThemeToggleIcon(); // keep tooltip localized
Â  Â  updateDetailsButtonLabel();
Â  }
Â  window.setLang = setLang;

Â  // ---------------- Theme (Auto / Light / Dark) â€” single icon button ----------------
Â  const THEME_LIGHT_VARS = {
Â  Â  '--bg':'#f0f2f5','--text':'#111','--muted':'#6e6e73','--border':'rgba(0,0,0,.08)',
Â  Â  '--card-bg':'rgba(255,255,255,.82)','--shadow':'0 14px 40px rgba(0,0,0,.10)'
Â  };
Â  const THEME_DARK_VARS = {
Â  Â  '--bg':'#0b0b0c','--text':'#f5f5f7','--muted':'#a1a1a6','--border':'rgba(255,255,255,.14)',
Â  Â  '--card-bg':'rgba(30,30,32,.8)','--shadow':'0 18px 50px rgba(0,0,0,.6)'
Â  };

Â  let themeChoice = localStorage.getItem('hkoTheme') || 'auto';
Â  const mqlDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');

Â  function applyTheme(choice = themeChoice){
Â  Â  themeChoice = choice;
Â  Â  localStorage.setItem('hkoTheme', themeChoice);

Â  Â  const old = document.getElementById('themeOverride');
Â  Â  if (old) old.remove();

Â  Â  if (themeChoice === 'auto'){
Â  Â  Â  if (mqlDark && !mqlDark._bound){
Â  Â  Â  Â  mqlDark.addEventListener('change', ()=> applyTheme('auto'));
Â  Â  Â  Â  mqlDark._bound = true;
Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  const vars = themeChoice === 'dark' ? THEME_DARK_VARS : THEME_LIGHT_VARS;
Â  Â  Â  const css = `:root{${Object.entries(vars).map(([k,v])=>`${k}:${v}`).join(';')}}`;
Â  Â  Â  const tag = document.createElement('style');
Â  Â  Â  tag.id = 'themeOverride';
Â  Â  Â  tag.textContent = css;
Â  Â  Â  document.head.appendChild(tag);
Â  Â  }
Â  Â  updateThemeToggleIcon();
Â  }

Â  function buildThemeToggle(){
Â  Â  const footer = document.querySelector('.footer');
Â  Â  if (!footer) return;

Â  Â  let wrap = document.getElementById('themeWrap');
Â  Â  if (!wrap){
Â  Â  Â  wrap = document.createElement('span');
Â  Â  Â  wrap.id = 'themeWrap';
Â  Â  Â  wrap.style.display = 'flex';
Â  Â  Â  wrap.style.alignItems = 'center';
Â  Â  Â  wrap.style.gap = '6px';
Â  Â  Â  wrap.style.marginLeft = '6px';
Â  Â  Â  const refreshBtn = document.getElementById('refreshBtn');
Â  Â  Â  footer.insertBefore(wrap, refreshBtn);
Â  Â  }else{
Â  Â  Â  wrap.innerHTML = '';
Â  Â  }

Â  Â  const btn = document.createElement('button');
Â  Â  btn.id = 'btnThemeCycle';
Â  Â  btn.type = 'button';
Â  Â  btn.style.border = '1px solid var(--border)';
Â  Â  btn.style.background = 'transparent';
Â  Â  btn.style.borderRadius = '10px';
Â  Â  btn.style.padding = '6px 10px';
Â  Â  btn.style.cursor = 'pointer';
Â  Â  btn.style.font = 'inherit';
Â  Â  btn.addEventListener('click', ()=>{
Â  Â  Â  const order = ['auto','light','dark'];
Â  Â  Â  const idx = order.indexOf(themeChoice);
Â  Â  Â  const next = order[(idx+1)%order.length];
Â  Â  Â  applyTheme(next);
Â  Â  });
Â  Â  wrap.appendChild(btn);

Â  Â  updateThemeToggleIcon();
Â  }

Â  function updateThemeToggleIcon(){
Â  Â  const btn = document.getElementById('btnThemeCycle');
Â  Â  if (!btn) return;
Â  Â  const icon = themeChoice==='dark' ? 'ğŸŒ™' : (themeChoice==='light' ? 'â˜€ï¸' : 'ğŸ–¥ï¸');
Â  Â  btn.textContent = icon;
Â  Â  const labelMap = {
Â  Â  Â  auto: t('theme') + ': ' + t('themeAuto'),
Â  Â  Â  light: t('theme') + ': ' + t('themeLight'),
Â  Â  Â  dark: t('theme') + ': ' + t('themeDark')
Â  Â  };
Â  Â  btn.title = labelMap[themeChoice];
Â  Â  btn.setAttribute('aria-label', labelMap[themeChoice]);
Â  }

Â  // Build API endpoint with language
Â  const API = 'https://data.weather.gov.hk/weatherAPI/opendata/weather.php';
Â  const urlOf = (dataType) => `${API}?dataType=${dataType}&lang=${LANG}`;

Â  // ---------- Live Hong Kong clock ----------
Â  function updateClock(){
Â  Â  const now=new Date();
Â  Â  const fmt={weekday:'short',year:'numeric',month:'short',day:'numeric',
Â  Â  Â  Â  Â  Â  Â  Â hour:'2-digit',minute:'2-digit',second:'2-digit',
Â  Â  Â  Â  Â  Â  Â  Â hour12:false,timeZone:'Asia/Hong_Kong'};
Â  Â  document.getElementById('hkClock').textContent=new Intl.DateTimeFormat('en-GB',fmt).format(now);
Â  }
Â  updateClock(); setInterval(updateClock,1000);

Â  // ---------- Language-aware HKO endpoints ----------
Â  const WARN_URL = () => urlOf('warnsum');
Â  //const WARN_URL = '.\\warnsum.json';
Â  const RHR_URL Â = () => urlOf('rhrread');
Â  const FND_URL Â = () => urlOf('fnd');

Â  // Icon helpers
Â  const hkoIconUrl = (n) => `https://www.weather.gov.hk/images/HKOWxIconOutline/pic${n}.png`;
Â  const owmIconUrl = (code) => `https://openweathermap.org/img/wn/${code}@2x.png`;

Â  // Map warning code -> generic HKO icon number (fallback only)
Â  function warningToIconNo(code, subtype){
Â  Â  code=(code||'').toUpperCase(); subtype=(subtype||'').toUpperCase();
Â  Â  if(code==='WTCSGNL'||code==='WTCPRE8'||code==='WMSGNL')return 80; // Typhoon/Pre-8/Monsoon
Â  Â  if(code==='WRAIN'){ if(subtype==='WRAINB')return 64; if(subtype==='WRAINR')return 63; return 62; }
Â  Â  if(code==='WTS')return 65;
Â  Â  if(code==='WFNTSA')return 63;
Â  Â  if(['WFIRE','WFIRER','WFIREY'].includes(code))return 81;
Â  Â  if(code==='WHOT')return 90;
Â  Â  if(['WCOLD','WFROST'].includes(code))return 93;
Â  Â  if(code==='WL')return 63;
Â  Â  if(code==='WTSUI')return 80;
Â  Â  return 60;
Â  }

Â  // ----- Helpers for fnd/rhr parsing -----
Â  function num(v){ const n = typeof v==='object' && v?.value!=null ? v.value : v; const x = Number(n); return isFinite(x) ? x : null; }
Â  function fmtDate(yyyymmdd){
Â  Â  if(!yyyymmdd) return '';
Â  Â  const s=String(yyyymmdd); const y=s.slice(0,4), m=s.slice(4,6), d=s.slice(6,8);
Â  Â  const dt=new Date(`${y}-${m}-${d}T00:00:00+08:00`);
Â  Â  return new Intl.DateTimeFormat('en-GB',{weekday:'short', day:'2-digit', month:'short'}).format(dt);
Â  }
Â  // Day-diff (Hong Kong time)
Â  function diffDaysHK(yyyymmdd){
Â  Â  if(!yyyymmdd) return null;
Â  Â  const s=String(yyyymmdd);
Â  Â  const y=s.slice(0,4), m=s.slice(4,6), d=s.slice(6,8);
Â  Â  const target = new Date(`${y}-${m}-${d}T00:00:00+08:00`);
Â  Â  const now = new Date();
Â  Â  const todayHK = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' }));
Â  Â  todayHK.setHours(0,0,0,0);
Â  Â  const diff = (target - todayHK)/(1000*60*60*24);
Â  Â  return Math.round(diff);
Â  }
Â  // Day/night
Â  function isDayHK(date){
Â  Â  const hk = new Date(date.toLocaleString('en-US',{timeZone:'Asia/Hong_Kong'}));
Â  Â  const h = hk.getHours();
Â  Â  return h >= 6 && h < 18;
Â  }

Â  // HKO -> icon URL (OWM preferred; HKO fallback 70â€“93)
Â  function iconSrcFromHko(hkoIconNo, dateForDayNight, forceDay=false){
Â  Â  const n = Number(hkoIconNo);
Â  Â  if (!Number.isFinite(n)) return hkoIconUrl(60);
Â  Â  if (n >= 70 && n <= 93) return hkoIconUrl(n);
Â  Â  const d = (forceDay || isDayHK(dateForDayNight ?? new Date())) ? 'd' : 'n';
Â  Â  if (n === 50) return owmIconUrl(`01${d}`);
Â  Â  if (n === 51 || n === 52) return owmIconUrl(`02${d}`);
Â  Â  if (n === 53 || n === 54) return owmIconUrl(`10${d}`);
Â  Â  if (n === 60 || n === 61) return owmIconUrl(`04${d}`);
Â  Â  if (n === 62 || n === 63 || n === 64) return owmIconUrl(`09${d}`);
Â  Â  if (n === 65) return owmIconUrl(`11${d}`);
Â  Â  return owmIconUrl(`03${d}`);
Â  }

Â  // -------- Custom warning icons from HKO legend --------
Â  function warnIconCustomSrc(code, subtype){
Â  Â  const c Â = (code||'').toUpperCase();
Â  Â  const st = (subtype||'').toUpperCase();
Â  Â  const IMG = 'https://www.hko.gov.hk/en/wxinfo/dailywx/images/';
Â  Â  if (c === 'WTCSGNL'){
Â  Â  Â  if (st === 'TC1') Â return IMG + 'tc1.gif';
Â  Â  Â  if (st === 'TC3') Â return IMG + 'tc3.gif';
Â  Â  Â  if (st === 'TC8NE') return IMG + 'tc8a.gif';
Â  Â  Â  if (st === 'TC8SE') return IMG + 'tc8b.gif';
Â  Â  Â  if (st === 'TC8SW') return IMG + 'tc8c.gif';
Â  Â  Â  if (st === 'TC8NW') return IMG + 'tc8d.gif';
Â  Â  Â  if (st === 'TC9') Â return IMG + 'tc9.gif';
Â  Â  Â  if (st === 'TC10') return IMG + 'tc10.gif';
Â  Â  }
Â  Â  if (c === 'WRAIN'){
Â  Â  Â  if (st === 'WRAINY') return IMG + 'raina.gif';
Â  Â  Â  if (st === 'WRAINR') return IMG + 'rainr.gif';
Â  Â  Â  if (st === 'WRAINB') return IMG + 'rainb.gif';
Â  Â  }
Â  Â  if (c === 'WTS') return IMG + 'ts.gif';
Â  Â  if (c === 'WFNTSA') return IMG + 'ntfl.gif';
Â  Â  if (c === 'WL') return IMG + 'landslip.gif';
Â  Â  if (c === 'WCOLD') return IMG + 'cold.gif';
Â  Â  if (c === 'WMSGNL') return IMG + 'sms.gif';
Â  Â  if (c === 'WFROST') return IMG + 'frost.gif';
Â  Â  if (c === 'WHOT') return IMG + 'vhot.gif';
Â  Â  if (c === 'WFIRER') return IMG + 'firer.gif';
Â  Â  if (c === 'WFIREY') return IMG + 'firey.gif';
Â  Â  if (c === 'WTSUI') return IMG + 'tsunami-warn.gif';
Â  Â  return null;
Â  }

Â  // -------- Location selection (no HTML/CSS change) --------
Â  let selectedPlace = localStorage.getItem('hkoPlace') || '';
Â  let lastRhr = null; // cache
Â  let lastFnd = null; // cache 9-day for expanding

Â  function buildLocationSelector(rhr){
Â  Â  lastRhr = rhr;
Â  Â  const stations = Array.isArray(rhr?.temperature?.data) ? rhr.temperature.data.slice() : [];
Â  Â  if (!stations.length) return;

Â  Â  const footer = document.querySelector('.footer');
Â  Â  if (!footer) return;

Â  Â  let wrapper = document.getElementById('locWrap');
Â  Â  if (!wrapper){
Â  Â  Â  wrapper = document.createElement('span');
Â  Â  Â  wrapper.id = 'locWrap';
Â  Â  Â  wrapper.style.display = 'flex';
Â  Â  Â  wrapper.style.alignItems = 'center';
Â  Â  Â  wrapper.style.gap = '6px';
Â  Â  Â  wrapper.style.flexWrap = 'wrap';
Â  Â  Â  wrapper.style.fontSize = '13px';
Â  Â  Â  const refreshBtn = document.getElementById('refreshBtn');
Â  Â  Â  footer.insertBefore(wrapper, refreshBtn);
Â  Â  }else{
Â  Â  Â  wrapper.innerHTML = '';
Â  Â  }

Â  Â  const label = document.createElement('span');
Â  Â  label.id = 'locLabel';
Â  Â  label.textContent = t('location');
Â  Â  wrapper.appendChild(label);

Â  Â  const sel = document.createElement('select');
Â  Â  sel.id = 'locSelect';
Â  Â  sel.style.padding = '6px 8px';
Â  Â  sel.style.border = '1px solid var(--border)';
Â  Â  sel.style.borderRadius = '10px';
Â  Â  sel.style.background = 'transparent';
Â  Â  sel.style.color = 'inherit';
Â  Â  sel.style.font = 'inherit';

Â  Â  stations.sort((a,b)=>{
Â  Â  Â  const ahko = /hong\s*kong\s*observatory/i.test(a.place||'');
Â  Â  Â  const bhko = /hong\s*kong\s*observatory/i.test(b.place||'');
Â  Â  Â  if (ahko && !bhko) return -1;
Â  Â  Â  if (!ahko && bhko) return 1;
Â  Â  Â  return String(a.place||'').localeCompare(String(b.place||''),'en');
Â  Â  });

Â  Â  stations.forEach(st=>{
Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  opt.value = st.place;
Â  Â  Â  opt.textContent = st.place;
Â  Â  Â  sel.appendChild(opt);
Â  Â  });

Â  Â  if (selectedPlace && stations.some(s=>s.place===selectedPlace)){
Â  Â  Â  sel.value = selectedPlace;
Â  Â  }else{
Â  Â  Â  const hkoStation = stations.find(s=>/hong\s*kong\s*observatory/i.test(s.place||''));
Â  Â  Â  sel.value = hkoStation ? hkoStation.place : stations[0].place;
Â  Â  Â  selectedPlace = sel.value;
Â  Â  Â  localStorage.setItem('hkoPlace', selectedPlace);
Â  Â  }

Â  Â  sel.addEventListener('change', ()=>{
Â  Â  Â  selectedPlace = sel.value;
Â  Â  Â  localStorage.setItem('hkoPlace', selectedPlace);
Â  Â  Â  renderTodayMetaWithLastData();
Â  Â  });

Â  Â  wrapper.appendChild(sel);
Â  }

Â  // ----- Manual language switcher (injected; no HTML/CSS edits) -----
Â  function buildLangSwitcher(){
Â  Â  const footer = document.querySelector('.footer');
Â  Â  if (!footer) return;

Â  Â  let wrap = document.getElementById('langWrap');
Â  Â  if (!wrap){
Â  Â  Â  wrap = document.createElement('span');
Â  Â  Â  wrap.id = 'langWrap';
Â  Â  Â  wrap.style.display = 'flex';
Â  Â  Â  wrap.style.alignItems = 'center';
Â  Â  Â  wrap.style.gap = '6px';
Â  Â  Â  wrap.style.marginLeft = '6px';
Â  Â  Â  const refreshBtn = document.getElementById('refreshBtn');
Â  Â  Â  footer.insertBefore(wrap, refreshBtn);
Â  Â  }else{
Â  Â  Â  wrap.innerHTML = '';
Â  Â  }

Â  Â  const mkBtn = (id, label, active) => {
Â  Â  Â  const b = document.createElement('button');
Â  Â  Â  b.id = id;
Â  Â  Â  b.type = 'button';
Â  Â  Â  b.textContent = label;
Â  Â  Â  b.style.border = '1px solid var(--border)';
Â  Â  Â  b.style.background = 'transparent';
Â  Â  Â  b.style.borderRadius = '10px';
Â  Â  Â  b.style.padding = '6px 10px';
Â  Â  Â  b.style.cursor = 'pointer';
Â  Â  Â  b.style.font = 'inherit';
Â  Â  Â  b.style.opacity = active ? '1' : '0.6';
Â  Â  Â  b.addEventListener('click', ()=> setLang(id === 'btnEN' ? 'en' : 'tc'));
Â  Â  Â  return b;
Â  Â  };

Â  Â  wrap.appendChild(mkBtn('btnEN', t('langEN'), LANG==='en'));
Â  Â  wrap.appendChild(mkBtn('btnTC', t('langTC'), LANG==='tc'));
Â  }

Â  function highlightLangButton(){
Â  Â  const btnEN = document.getElementById('btnEN');
Â  Â  const btnTC = document.getElementById('btnTC');
Â  Â  if (btnEN) btnEN.style.opacity = (LANG==='en' ? '1' : '0.6');
Â  Â  if (btnTC) btnTC.style.opacity = (LANG==='tc' ? '1' : '0.6');
Â  Â  if (btnEN) btnEN.textContent = t('langEN');
Â  Â  if (btnTC) btnTC.textContent = t('langTC');
Â  }

Â  // ----- Details (expand/collapse to 6-day) -----
Â  let detailsExpanded = (localStorage.getItem('hkoDetailsExpanded') || '0') === '1';

Â  function buildDetailsToggle(){
Â  Â  const footer = document.querySelector('.footer');
Â  Â  if (!footer) return;

Â  Â  let wrap = document.getElementById('detailsWrap');
Â  Â  if (!wrap){
Â  Â  Â  wrap = document.createElement('span');
Â  Â  Â  wrap.id = 'detailsWrap';
Â  Â  Â  wrap.style.display = 'flex';
Â  Â  Â  wrap.style.alignItems = 'center';
Â  Â  Â  wrap.style.gap = '6px';
Â  Â  Â  wrap.style.marginLeft = '6px';
Â  Â  Â  const refreshBtn = document.getElementById('refreshBtn');
Â  Â  Â  footer.insertBefore(wrap, refreshBtn);
Â  Â  }else{
Â  Â  Â  wrap.innerHTML = '';
Â  Â  }

Â  Â  const btn = document.createElement('button');
Â  Â  btn.id = 'btnDetails';
Â  Â  btn.type = 'button';
Â  Â  btn.style.border = '1px solid var(--border)';
Â  Â  btn.style.background = 'transparent';
Â  Â  btn.style.borderRadius = '10px';
Â  Â  btn.style.padding = '6px 10px';
Â  Â  btn.style.cursor = 'pointer';
Â  Â  btn.style.font = 'inherit';
Â  Â  btn.addEventListener('click', ()=>{
Â  Â  Â  detailsExpanded = !detailsExpanded;
Â  Â  Â  localStorage.setItem('hkoDetailsExpanded', detailsExpanded ? '1' : '0');
Â  Â  Â  updateDetailsButtonLabel();
Â  Â  Â  renderForecastRows(); // re-render rows according to state
Â  Â  });
Â  Â  wrap.appendChild(btn);

Â  Â  updateDetailsButtonLabel();
Â  }
Â  function updateDetailsButtonLabel(){
Â  Â  const btn = document.getElementById('btnDetails');
Â  Â  if (!btn) return;
Â  Â  btn.textContent = detailsExpanded ? t('detailsLess') : t('detailsMore');
Â  }

Â  // ----- Temperature / rain helpers -----
Â  function extractTempForPlace(rhr, placeName){
Â  Â  const list = rhr?.temperature?.data;
Â  Â  if (!Array.isArray(list) || !list.length) return null;
Â  Â  const picked = list.find(it => (it.place||'') === placeName);
Â  Â  if (picked) return num(picked?.value ?? picked?.temp ?? picked?.reading);
Â  Â  return null;
Â  }

Â  function extractCurrentTempC(rhr){
Â  Â  if (selectedPlace){
Â  Â  Â  const v = extractTempForPlace(rhr, selectedPlace);
Â  Â  Â  if (v != null) return v;
Â  Â  }
Â  Â  const list = rhr?.temperature?.data;
Â  Â  if (!Array.isArray(list) || !list.length) return null;
Â  Â  const hko = list.find(it => typeof it?.place === 'string' && /hong\s*kong\s*observatory/i.test(it.place));
Â  Â  const cand = hko || list[0];
Â  Â  return num(cand?.value ?? cand?.temp ?? cand?.reading);
Â  }

Â  function extractTodayRainChance(fnd){
Â  Â  const today = Array.isArray(fnd?.weatherForecast) ? fnd.weatherForecast[0] : null;
Â  Â  if (!today) return null;
Â  Â  const pctNum = num(today?.ForecastChanceOfRain ?? today?.forecastChanceOfRain ?? today?.PSR?.value);
Â  Â  if (pctNum != null) return `${pctNum}%`;
Â  Â  const psrTxt = today?.PSR ?? today?.forecastPSR ?? today?.forecastPsr;
Â  Â  return psrTxt ? String(psrTxt) : null;
Â  }

Â  // Localize static labels already in the DOM
Â  function applyStaticLabels(){
Â  Â  const labels = document.querySelectorAll('.row-label');
Â  Â  if (labels[0]) labels[0].textContent = t('activeWarnings');
Â  Â  const todaySpan = document.querySelector('.today-line span');
Â  Â  if (todaySpan) todaySpan.textContent = t('today');
Â  Â  const lr = document.getElementById('lastRefresh');
Â  Â  if (lr && lr.textContent){
Â  Â  Â  const ts = lr.textContent.replace(/^[^:]+:\s*/, '');
Â  Â  Â  lr.textContent = t('lastChecked') + ts;
Â  Â  }
Â  Â  const locLabel = document.getElementById('locLabel');
Â  Â  if (locLabel) locLabel.textContent = t('location');

Â  Â  buildLangSwitcher();
Â  Â  highlightLangButton();
Â  Â  buildThemeToggle();
Â  Â  updateThemeToggleIcon();
Â  Â  buildDetailsToggle();
Â  }

Â  // Render "Today: [icon] Temp (Place): xxÂ°C Â· Raining: yy%"
Â  function renderTodayMeta(tempC, rainChance){
Â  Â  const todayLine = document.querySelector('.today-line');
Â  Â  if (!todayLine) return;
Â  Â  let meta = document.getElementById('todayMeta');
Â  Â  if (!meta){
Â  Â  Â  meta = document.createElement('span');
Â  Â  Â  meta.id = 'todayMeta';
Â  Â  Â  meta.style.marginLeft = '6px';
Â  Â  Â  meta.style.fontSize = '0.95em';
Â  Â  Â  meta.style.color = 'inherit';
Â  Â  Â  todayLine.appendChild(meta);
Â  Â  }
Â  Â  const parts = [];
Â  Â  if (tempC != null){
Â  Â  Â  const place = selectedPlace ? ` (${selectedPlace})` : '';
Â  Â  Â  const val = Math.round(Number(tempC));
Â  Â  Â  parts.push(`${t('temp')}${place}: ${val}Â°C`);
Â  Â  }
Â  Â  if (rainChance) parts.push(`${t('raining')}: ${rainChance}`);
Â  Â  meta.textContent = parts.join(' Â· ');
Â  }
Â  function renderTodayMetaWithLastData(){
Â  Â  if (!lastRhr) return;
Â  Â  const tempC = extractCurrentTempC(lastRhr);
Â  Â  const meta = document.getElementById('todayMeta');
Â  Â  let rainTxt = '';
Â  Â  if (meta && meta.textContent){
Â  Â  Â  const m = meta.textContent.match(/(?:Raining|é™é›¨æ©Ÿç‡):\s*[^Â·]+/);
Â  Â  Â  rainTxt = m ? m[0].split(':')[1].trim() : '';
Â  Â  }
Â  Â  renderTodayMeta(tempC, rainTxt || null);
Â  }

Â  const dom={
Â  Â  icons:document.getElementById('hko-icons'),
Â  Â  weatherIcon:document.getElementById('weather-icon'),
Â  Â  fndBody:document.getElementById('fndBody'),
Â  Â  last:document.getElementById('lastRefresh'),
Â  Â  refresh:document.getElementById('refreshBtn')
Â  };

Â  function humanFull(d){
Â  Â  return new Intl.DateTimeFormat(undefined,{dateStyle:'short',timeStyle:'medium'}).format(d);
Â  }

Â  function fitWarningIcons(){
Â  Â  const row = dom.icons;
Â  Â  const count = row.querySelectorAll('img').length || 1;
Â  Â  const w = row.clientWidth;
Â  Â  const gap = 12;
Â  Â  let size = Math.max(40, Math.min(72, Math.floor(w / Math.max(3, count))));
Â  Â  while (size > 28 && (count*size + (count-1)*gap) > w) size -= 2;
Â  Â  document.documentElement.style.setProperty('--warn-icon', size + 'px');
Â  Â  document.documentElement.style.setProperty('--today-icon', Math.min(size+4, 64) + 'px');
Â  }

Â  // -------- Forecast rendering (3-day base + optional extra 3) --------
Â  function fmtRow(it){
Â  Â  const iconNo = Number(it?.ForecastIcon ?? it?.forecastIcon);
Â  Â  const dateStr = String(it?.forecastDate ?? it?.ForecastDate);
Â  Â  const y=dateStr.slice(0,4), m=dateStr.slice(4,6), d=dateStr.slice(6,8);
Â  Â  const hkNoon = new Date(`${y}-${m}-${d}T12:00:00+08:00`);
Â  Â  const iconSrc = iconSrcFromHko(iconNo || 60, hkNoon, true);
Â  Â  const minT Â  = num(it?.ForecastMinTemp ?? it?.forecastMintemp ?? it?.forecastMintemp?.value);
Â  Â  const maxT Â  = num(it?.ForecastMaxTemp ?? it?.forecastMaxtemp ?? it?.forecastMaxtemp?.value);
Â  Â  const date Â  = it?.forecastDate ?? it?.ForecastDate;
Â  Â  const desc Â  = it?.forecastWeather ?? it?.ForecastWeather ?? '';

Â  Â  const tr = document.createElement('tr');
Â  Â  const tdDate = document.createElement('td');
Â  Â  tdDate.textContent = fmtDate(date);
Â  Â  tr.appendChild(tdDate);

Â  Â  const tdIcon = document.createElement('td');
Â  Â  tdIcon.className = 'icon-cell';
Â  Â  const img = document.createElement('img');
Â  Â  img.src = iconSrc;
Â  Â  img.alt = '';
Â  Â  tdIcon.appendChild(img);
Â  Â  tr.appendChild(tdIcon);

Â  Â  const tdTemp = document.createElement('td');
Â  Â  tdTemp.className = 'temp';
Â  Â  tdTemp.textContent =
Â  Â  Â  (Number.isFinite(minT) && Number.isFinite(maxT)) ? `${minT} â€“ ${maxT}` :
Â  Â  Â  (Number.isFinite(maxT) ? `${maxT}` : '');
Â  Â  tr.appendChild(tdTemp);

Â  Â  const tdDesc = document.createElement('td');
Â  Â  tdDesc.className = 'desc';
Â  Â  tdDesc.textContent = desc;
Â  Â  tr.appendChild(tdDesc);

Â  Â  return tr;
Â  }

Â  function renderForecastRows(){
Â  Â  // Clear all rows first
Â  Â  dom.fndBody.innerHTML = '';

Â  Â  const arr = Array.isArray(lastFnd?.weatherForecast) ? lastFnd.weatherForecast : [];
Â  Â  if (!arr.length) return;

Â  Â  // Always show exactly +1, +2, +3
Â  Â  const baseDays = [1,2,3];
Â  Â  const base = arr
Â  Â  Â  .map(it => ({ it, d: diffDaysHK(it?.forecastDate ?? it?.ForecastDate) }))
Â  Â  Â  .filter(x => baseDays.includes(x.d))
Â  Â  Â  .sort((a,b)=>a.d-b.d)
Â  Â  Â  .map(x => x.it);

Â  Â  base.forEach(it => dom.fndBody.appendChild(fmtRow(it)));

Â  Â  // If expanded, also add +4, +5, +6
Â  Â  if (detailsExpanded){
Â  Â  Â  const extraDays = [4,5,6];
Â  Â  Â  const extra = arr
Â  Â  Â  Â  .map(it => ({ it, d: diffDaysHK(it?.forecastDate ?? it?.ForecastDate) }))
Â  Â  Â  Â  .filter(x => extraDays.includes(x.d))
Â  Â  Â  Â  .sort((a,b)=>a.d-b.d)
Â  Â  Â  Â  .map(x => x.it);

Â  Â  Â  extra.forEach(it => {
Â  Â  Â  Â  const tr = fmtRow(it);
Â  Â  Â  Â  tr.setAttribute('data-extra','1');
Â  Â  Â  Â  dom.fndBody.appendChild(tr);
Â  Â  Â  });
Â  Â  }
Â  }

Â  async function fetchAll(){
Â  Â  applyStaticLabels(); // reflect current language/theme/buttons

Â  Â  // reset UI sections that always re-render
Â  Â  dom.icons.innerHTML='';
Â  Â  dom.weatherIcon.src=''; dom.weatherIcon.alt='';
Â  Â  dom.fndBody.innerHTML='';

Â  Â  try{
Â  Â  Â  const [warnRes, rhrRes, fndRes] = await Promise.all([
Â  Â  Â  Â  fetch(WARN_URL(),{cache:'no-store'}),
Â  Â  Â  Â  fetch(RHR_URL(),{cache:'no-store'}),
Â  Â  Â  Â  fetch(FND_URL(),{cache:'no-store'})
Â  Â  Â  ]);

Â  Â  Â  // ---- warnings ----
Â  Â  Â  const warnData = await warnRes.json();
Â  Â  Â  const entries = Object.entries(warnData).filter(([_,v])=>v && typeof v==='object' && v.code);
Â  Â  Â  if(entries.length===0){
Â  Â  Â  Â  dom.icons.textContent = t('noWarning');
Â  Â  Â  }else{
Â  Â  Â  Â  for(const [,w] of entries){
Â  Â  Â  Â  Â  const img=document.createElement('img');
Â  Â  Â  Â  Â  const custom = warnIconCustomSrc(w.code, w.type || w.subtype);
Â  Â  Â  Â  Â  img.src = custom || hkoIconUrl(warningToIconNo(w.code, w.type || w.subtype));
Â  Â  Â  Â  Â  img.alt = '';
Â  Â  Â  Â  Â  dom.icons.appendChild(img);
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // ---- parse rhr + fnd ----
Â  Â  Â  let rhr=null, fnd=null;
Â  Â  Â  try { rhr = await rhrRes.json(); } catch {}
Â  Â  Â  try { fnd = await fndRes.json(); } catch {}
Â  Â  Â  lastFnd = fnd;

Â  Â  Â  // Location / Lang / Theme controls
Â  Â  Â  if (rhr) buildLocationSelector(rhr);
Â  Â  Â  buildLangSwitcher();
Â  Â  Â  buildThemeToggle();
Â  Â  Â  buildDetailsToggle();

Â  Â  Â  // TODAY icon
Â  Â  Â  let todayHkoIconNo = null;
Â  Â  Â  if (rhr && Array.isArray(rhr.icon) && rhr.icon.length>0){
Â  Â  Â  Â  const first = rhr.icon[0];
Â  Â  Â  Â  todayHkoIconNo = typeof first==='number' ? first :
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â (typeof first==='string' ? parseInt(first,10) : null);
Â  Â  Â  }
Â  Â  Â  if (todayHkoIconNo==null && fnd && Array.isArray(fnd.weatherForecast) && fnd.weatherForecast.length>0){
Â  Â  Â  Â  const ic = fnd.weatherForecast[0].ForecastIcon ?? fnd.weatherForecast[0].forecastIcon;
Â  Â  Â  Â  if (typeof ic==='number') todayHkoIconNo = ic;
Â  Â  Â  Â  else if (typeof ic==='string') todayHkoIconNo = parseInt(ic,10) || null;
Â  Â  Â  }
Â  Â  Â  dom.weatherIcon.src = iconSrcFromHko(todayHkoIconNo ?? 60, new Date(), false);

Â  Â  Â  // Today meta
Â  Â  Â  if (rhr) lastRhr = rhr;
Â  Â  Â  const tempC = rhr ? extractCurrentTempC(rhr) : null;
Â  Â  Â  const rainChance = (fnd ? extractTodayRainChance(fnd) : null);
Â  Â  Â  renderTodayMeta(tempC, rainChance);

Â  Â  Â  // Forecast rows (3-day or 6-day depending on toggle)
Â  Â  Â  renderForecastRows();

Â  Â  Â  // Last checked
Â  Â  Â  dom.last.textContent = t('lastChecked') + humanFull(new Date());

Â  Â  Â  requestAnimationFrame(fitWarningIcons);

Â  Â  }catch(e){
Â  Â  Â  dom.icons.textContent = t('error');
Â  Â  Â  requestAnimationFrame(fitWarningIcons);
Â  Â  }
Â  }
/* ---- Minimal geolocation -> nearest HKO station hookup ---- */

// 1) A small sample of HKO stations with rough coords.
// Â  Â Add/expand this list for better accuracy.
const HKO_STATIONS_LUT = [
Â  { place: 'Hong Kong Observatory', lat: 22.302, lng: 114.174 },
Â  { place: 'Kowloon City', Â  Â  Â  Â  lat: 22.328, lng: 114.191 },
Â  { place: 'Sha Tin', Â  Â  Â  Â  Â  Â  Â lat: 22.382, lng: 114.191 },
Â  { place: 'Tsim Bei Tsui', Â  Â  Â  Â lat: 22.479, lng: 113.997 },
Â  { place: 'Chek Lap Kok', Â  Â  Â  Â  lat: 22.308, lng: 113.918 },
Â  { place: 'Ta Kwu Ling', Â  Â  Â  Â  Â lat: 22.532, lng: 114.148 },
Â  { place: 'Waglan Island', Â  Â  Â  Â lat: 22.181, lng: 114.303 },
Â  { place: 'Tsuen Wan', Â  Â  Â  Â  Â  Â lat: 22.373, lng: 114.114 },
Â  { place: 'Sai Kung', Â  Â  Â  Â  Â  Â  lat: 22.383, lng: 114.270 },
Â  { place: 'Yuen Long Park', Â  Â  Â  lat: 22.446, lng: 114.025 }
];

// 2) Distance helper (haversine)
function haversineKm(a, b){
Â  const toRad = (x)=> x*Math.PI/180;
Â  const R = 6371;
Â  const dLat = toRad(b.lat-a.lat);
Â  const dLng = toRad(b.lng-a.lng);
Â  const s1 = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
Â  return 2*R*Math.asin(Math.sqrt(s1));
}

// 3) Find nearest station name from LUT
function nearestStationName(lat, lng){
Â  if (!HKO_STATIONS_LUT.length) return null;
Â  let best = HKO_STATIONS_LUT[0], bestD = Infinity;
Â  for (const st of HKO_STATIONS_LUT){
Â  Â  const d = haversineKm({lat,lng}, {lat:st.lat, lng:st.lng});
Â  Â  if (d < bestD){ bestD = d; best = st; }
Â  }
Â  return best.place;
}

// 4) Ask for location, snap selection, and update UI/meta
async function useMyLocation(){
Â  if (!('geolocation' in navigator)){
Â  Â  alert('Geolocation not supported by this browser.');
Â  Â  return;
Â  }
Â  navigator.geolocation.getCurrentPosition(pos=>{
Â  Â  const {latitude, longitude} = pos.coords || {};
Â  Â  if (latitude==null || longitude==null) return;
Â  Â  const name = nearestStationName(latitude, longitude);
Â  Â  if (!name) return;

Â  Â  // set + persist selection
Â  Â  selectedPlace = name;
Â  Â  localStorage.setItem('hkoPlace', selectedPlace);

Â  Â  // update dropdown if it exists
Â  Â  const sel = document.getElementById('locSelect');
Â  Â  if (sel && [...sel.options].some(o=>o.value===name)){
Â  Â  Â  sel.value = name;
Â  Â  }

Â  Â  // re-render temp line using already-fetched rhr (lastRhr)
Â  Â  renderTodayMetaWithLastData();
Â  }, err=>{
Â  Â  // optional: show a gentle message or ignore
Â  Â  console.warn('Geolocation denied or failed:', err);
Â  }, { enableHighAccuracy:true, timeout:8000, maximumAge:30000 });
}

// 5) Add a tiny "ğŸ“" button next to the location selector (injected, no HTML edit)
function addLocateButton(){
Â  const wrapper = document.getElementById('locWrap');
Â  if (!wrapper || document.getElementById('locateBtn')) return;
Â  const btn = document.createElement('button');
Â  btn.id = 'locateBtn';
Â  btn.type = 'button';
Â  btn.textContent = 'ğŸ“';
Â  btn.title = (LANG==='tc' ? 'ä½¿ç”¨æˆ‘çš„ä½ç½®' : 'Use my location');
Â  btn.style.border = '1px solid var(--border)';
Â  btn.style.background = 'transparent';
Â  btn.style.borderRadius = '10px';
Â  btn.style.padding = '6px 10px';
Â  btn.style.cursor = 'pointer';
Â  btn.style.font = 'inherit';
Â  btn.style.marginLeft = '2px';
Â  btn.addEventListener('click', useMyLocation);
Â  wrapper.appendChild(btn);
}

// Hook into your existing location builder so the button appears automatically
const _origBuildLocationSelector = buildLocationSelector;
buildLocationSelector = function(rhr){
Â  _origBuildLocationSelector.call(this, rhr);
Â  addLocateButton();
};
Â  // ---- INIT ----
Â  applyTheme(themeChoice); Â  Â  Â  Â  Â // apply saved theme immediately
Â  applyStaticLabels(); Â  Â  Â  Â  Â  Â  Â // build language, theme, and details UI
Â  fetchAll();
Â  document.getElementById('refreshBtn').addEventListener('click', fetchAll);
Â  setInterval(fetchAll, 5*60*1000);
Â  window.addEventListener('resize', fitWarningIcons);
</script>
</body>
</html>
